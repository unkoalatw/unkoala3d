<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖 - 首頁</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f7f4; }
        .hero-section { background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80'); background-size: cover; background-position: center; }
        .tag { background-color: #dcfce7; color: #16a34a; }
        .tag.active { background-color: #16a34a; color: white; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); transition: all 0.3s ease; color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .shop-card { transition: all 0.3s ease; display: flex; flex-direction: column; }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .shop-card > div.p-6 { display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .shop-card button { margin-top: auto; }
        .shop-detail-header { background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80'); background-size: cover; background-position: center; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        #sustainability-map { width: 100%; height: 500px; min-height: 400px; }
        .favorite-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.8); border-radius: 50%; padding: 0.5rem; cursor: pointer; transition: transform 0.2s ease; }
        .favorite-btn:hover { transform: scale(1.1); }
        .favorite-btn svg { width: 1.5rem; height: 1.5rem; stroke: #4b5563; stroke-width: 1.5; fill: none; }
        .favorite-btn.favorited svg { fill: #ef4444; stroke: #ef4444; }
        .admin-mode { position: fixed; top: 10px; right: 10px; background: rgba(255, 0, 0, 0.8); color: white; padding: 8px 16px; border-radius: 4px; z-index: 1000; font-size: 14px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #34d399; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; }
        .error-modal-content { max-height: 70vh; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <div id="admin-indicator" class="admin-mode hidden">管理員模式</div>

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <a href="#" class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600 transition" data-i18n="home">首頁</a>
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">訂閱電子報</a>
                <a href="#report-issue" class="text-gray-700 hover:text-green-600 transition" data-i18n="reportIssueNavLink">問題回報</a>
                <select id="language-select" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer">
                    <option value="zh-TW" data-i18n="langChinese">繁體中文</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                </select>
            </div>
             <div class="md:hidden flex items-center">
                <select id="language-select-mobile" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition cursor-pointer mr-2">
                    <option value="zh-TW" data-i18n="langChinese">繁體中文</option>
                    <option value="en" data-i18n="langEnglish">English</option>
                </select>
                <button id="menu-toggle" class="text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white">
            <a href="#" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="home">首頁</a>
            <a href="#map" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="map">地圖</a>
            <a href="#shops" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="shopList">商店列表</a>
            <a href="#newsletter" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="newsletter">訂閱電子報</a>
            <a href="#report-issue" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="reportIssueNavLink">問題回報</a>
        </div>
    </nav>

    <div id="announcement-bar" class="hidden bg-yellow-200 border-b-2 border-yellow-300 text-yellow-800 p-3 text-center">
        <p id="announcement-text" class="font-medium"></p>
    </div>

    <section class="hero-section py-20 md:py-32 text-white">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
            <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力</p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">查看地圖</a>
                <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">瀏覽商店列表</a>
            </div>
        </div>
    </section>

    <main>
        <section class="py-12 bg-white">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
                            <div class="flex">
                                <input type="text" id="search-input" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500" data-i18n="searchPlaceholder" placeholder="輸入商店名稱或地址...">
                                <button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
                            <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                                <button class="tag px-3 py-1 rounded-full text-sm active" data-i18n="filterAll" data-category="all">全部</button>
                                <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterFavorites" data-category="favorites">❤️ 我的收藏</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="map" class="py-12 bg-green-50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div id="sustainability-map" class="h-96 md:h-[500px] w-full z-10"></div>
                </div>
            </div>
        </section>

        <section id="shops" class="py-12 bg-white">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container">
                </div>
                <div class="text-center mt-8">
                    <button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg font-medium hidden" data-i18n="loadMoreBtn">載入更多</button>
                </div>
            </div>
        </section>

        <section id="newsletter" class="py-12 bg-green-600 text-white">
            <div class="container mx-auto px-4">
                <div class="max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱永續生活電子報</h2>
                    <p class="mb-6" data-i18n="newsletterSubtitle">獲取最新的永續商店資訊、環保生活技巧和特別優惠</p>
                    <form id="newsletter-form" class="flex flex-col md:flex-row gap-2">
                        <input type="email" id="newsletter-email" required class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder" placeholder="您的電子郵件">
                        <button type="submit" id="subscribe-button" class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn">訂閱</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="report-issue" class="py-12 bg-yellow-50">
            <div class="container mx-auto px-4">
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-center mb-6" data-i18n="reportIssueTitle">問題回報</h2>
                    <form id="issue-form">
                        <div class="mb-4">
                            <label for="issue" class="block text-gray-700 text-sm font-bold mb-2" data-i18n="reportIssueLabel">請描述您遇到的問題：</label>
                            <textarea id="issue" name="issue" rows="6" required
                                      class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                      data-i18n="reportIssuePlaceholder"
                                      placeholder="例如：某間商店資訊錯誤、地圖位置有誤..."></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit"
                                    class="btn-primary px-6 py-2 rounded-lg font-medium"
                                    data-i18n="reportIssueSubmitBtn">
                                送出回報
                            </button>
                        </div>
                    </form>
                    <p id="issue-message" class="text-center text-green-600 mt-4 hidden" data-i18n="reportIssueSuccessMsg">感謝您的回報，我們會儘快處理！</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4 text-center">
            <p data-i18n="copyright">© 2025 永續商店地圖 - 版權所有</p>
        </div>
    </footer>

    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center">
        <div id="shop-detail-container" class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content">
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto text-center">
            <p id="message-modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button id="close-message-modal" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="okButton">確定</button>
        </div>
    </div>
    
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[3000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-2xl w-full mx-auto">
            <h3 class="text-xl font-bold text-red-600 mb-4" data-i18n="errorModalTitle">發生錯誤</h3>
            <div class="bg-red-50 p-4 rounded-md error-modal-content overflow-y-auto">
                <pre id="error-details" class="text-sm text-gray-800 whitespace-pre-wrap break-all"></pre>
            </div>
            <div class="mt-6 text-right">
                <button id="close-error-modal" class="bg-red-600 text-white px-6 py-2 rounded-lg font-medium">關閉</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ===== CONFIGURATION =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbzIcS0WXSQV0yNt5lyjvHy7hwDIUItkGeG78T_Yz2mKa83HJMgI9UxsfVIelU6PyKFwkw/exec';

    // ===== GLOBAL STATE =====
    let allShops = [];
    let currentFilterCategory = 'all';
    let currentSearchQuery = '';
    const shopsPerPage = 6;
    let currentLoadedShops = 0;
    let mapInstance;
    let markersGroup = L.featureGroup();
    let favoriteShops = JSON.parse(localStorage.getItem('favoriteShops')) || [];
    let currentLang = localStorage.getItem('lang') || 'zh-TW';

    const translations = {
        'zh-TW': {
            pageTitle: '永續商店地圖 - 首頁', appName: '永續商店地圖', home: '首頁', map: '地圖', shopList: '商店列表', newsletter: '訂閱電子報', reportIssueNavLink: '問題回報',
            langChinese: '繁體中文', langEnglish: 'English',
            heroTitle: '探索台灣永續商店', heroSubtitle: '找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力',
            viewMapBtn: '查看地圖', browseShopsBtn: '瀏覽商店列表', searchTitle: '搜尋永續商店', searchPlaceholder: '輸入商店名稱或地址...',
            filterCategoryTitle: '依類別篩選', filterAll: '全部', filterFavorites: '我的收藏',
            mapSectionTitle: '永續商店地圖', shopListSectionTitle: '永續商店列表', viewDetailsBtn: '查看詳情', loadMoreBtn: '載入更多',
            newsletterTitle: '訂閱永續生活電子報', newsletterSubtitle: '獲取最新的永續商店資訊、環保生活技巧和特別優惠', newsletterPlaceholder: '您的電子郵件', subscribeBtn: '訂閱',
            reportIssueTitle: '問題回報', reportIssueLabel: '請描述您遇到的問題：', reportIssuePlaceholder: '例如：某間商店資訊錯誤、地圖位置有誤...', reportIssueSubmitBtn: '送出回報',
            reportIssueSuccessMsg: '感謝您的回報，我們會儘快處理！', reportIssueErrorMsg: '回報失敗，請稍後再試。',
            okButton: '確定', notProvided: '未提供', copyright: '© 2025 永續商店地圖 - 版權所有',
            modalAddress: '地址', modalOpeningHours: '營業時間', modalContactInfo: '聯絡方式', modalPhone: '電話', modalWebsite: '網站',
            adminLoginPrompt: '請輸入管理員密碼：', adminLoginSuccess: '已進入管理員模式',
            recommendationSending: '正在發送推薦信...', recommendationSuccess: '推薦信已成功寄出！',
            apiError: '發生錯誤，請稍後再試。', newsletterSuccess: '感謝您的訂閱！',
            adminRecommendBtn: '推薦此店家給所有訂閱者',
            errorModalTitle: '發生錯誤'
        },
        'en': {
            pageTitle: 'Sustainable Store Map - Home', appName: 'Sustainable Store Map', home: 'Home', map: 'Map', shopList: 'Shop List', newsletter: 'Newsletter', reportIssueNavLink: 'Report Issue',
            langChinese: '繁體中文', langEnglish: 'English',
            heroTitle: 'Explore Taiwan\'s Sustainable Stores', heroSubtitle: 'Find stores that support environmental protection, fair trade, and sustainable development.',
            viewMapBtn: 'View Map', browseShopsBtn: 'Browse Shops', searchTitle: 'Search Sustainable Stores', searchPlaceholder: 'Enter store name or address...',
            filterCategoryTitle: 'Filter by Category', filterAll: 'All', filterFavorites: 'My Favorites',
            mapSectionTitle: 'Sustainable Store Map', shopListSectionTitle: 'Sustainable Shop List', viewDetailsBtn: 'View Details', loadMoreBtn: 'Load More',
            newsletterTitle: 'Subscribe to our Newsletter', newsletterSubtitle: 'Get the latest sustainable store info, eco-friendly tips, and special offers.', newsletterPlaceholder: 'Your email', subscribeBtn: 'Subscribe',
            reportIssueTitle: 'Report an Issue', reportIssueLabel: 'Please describe the issue you encountered:', reportIssuePlaceholder: 'e.g., Incorrect store information, wrong map location...', reportIssueSubmitBtn: 'Submit Report',
            reportIssueSuccessMsg: 'Thank you for your report, we will process it soon!', reportIssueErrorMsg: 'Failed to submit report. Please try again later.',
            okButton: 'OK', notProvided: 'Not provided', copyright: '© 2025 Sustainable Store Map - All Rights Reserved',
            modalAddress: 'Address', modalOpeningHours: 'Opening Hours', modalContactInfo: 'Contact Info', modalPhone: 'Phone', modalWebsite: 'Website',
            adminLoginPrompt: 'Please enter admin password:', adminLoginSuccess: 'Admin mode activated',
            recommendationSending: 'Sending recommendation...', recommendationSuccess: 'Recommendation sent successfully!',
            apiError: 'An error occurred. Please try again later.', newsletterSuccess: 'Thank you for subscribing!',
            adminRecommendBtn: 'Recommend this store to all subscribers',
            errorModalTitle: 'An Error Occurred'
        }
    };

    // ===== UI ELEMENTS =====
    const ui = {
        loadingOverlay: document.getElementById('loading-overlay'),
        adminIndicator: document.getElementById('admin-indicator'),
        shopCardsContainer: document.getElementById('shop-cards-container'),
        loadMoreButton: document.getElementById('load-more-button'),
        announcementBar: document.getElementById('announcement-bar'),
        announcementText: document.getElementById('announcement-text'),
        messageModal: document.getElementById('message-modal'),
        messageModalText: document.getElementById('message-modal-text'),
        shopDetailModal: document.getElementById('shop-detail-modal'),
        shopDetailContainer: document.getElementById('shop-detail-container'),
        errorModal: document.getElementById('error-modal'),
        errorDetails: document.getElementById('error-details')
    };

    // ===== API & ERROR HANDLING =====
    function showErrorModal(error, action) {
        let details = `Action: ${action}\n`;
        details += `Error: ${error.name || 'Unknown Error'}: ${error.message}\n\n`;
        if(error.responseText) {
            details += `Backend Response:\n------------------\n${error.responseText}\n------------------\n\n`;
        }
        if(error.stack) {
            details += `Stack Trace:\n${error.stack}`;
        }
        ui.errorDetails.textContent = details;
        ui.errorModal.classList.remove('hidden');
    }
    
    async function apiFetch(action, payload = {}, requiresAuth = false) {
        ui.loadingOverlay.classList.remove('hidden');
        try {
            const token = localStorage.getItem('authToken');
            if (requiresAuth && !token) {
                throw new Error("Authentication required.");
            }
            
            const body = { action, ...payload };
            if (requiresAuth) body.token = token;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(body),
                mode: 'cors'
            });
            
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                const parseError = new Error("Failed to parse JSON response from backend.");
                parseError.responseText = text;
                throw parseError;
            }

            if (result.status === 'error') throw new Error(result.message);
            return result.data;

        } catch (error) {
            console.error(`API Fetch Error (${action}):`, error);
            showErrorModal(error, action);
            return null;
        } finally {
            ui.loadingOverlay.classList.add('hidden');
        }
    }

    // ===== CORE FUNCTIONS =====
    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('lang', lang);
        document.documentElement.lang = lang;

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const translation = translations[lang]?.[key] || translations['zh-TW'][key];
            if (el.placeholder) {
                el.placeholder = translation;
            } else {
                el.textContent = translation;
            }
        });
        
        document.getElementById('language-select').value = lang;
        document.getElementById('language-select-mobile').value = lang;
        
        currentLoadedShops = 0;
        filterAndDisplayShops();
        
        if (!ui.shopDetailModal.classList.contains('hidden')) {
            const shopId = ui.shopDetailModal.dataset.shopId;
            if (shopId) showShopDetail(shopId);
        }
    }

    function getFilteredShops() {
        return allShops.filter(shop => {
            if (!shop || !shop.id) return false;
            
            if (currentFilterCategory === 'favorites') {
                return favoriteShops.includes(shop.id);
            }

            const matchesCategory = currentFilterCategory === 'all' || (shop['type_zh-TW']) === currentFilterCategory;

            const name = shop[`name_${currentLang}`] || shop['name_zh-TW'] || '';
            const address = shop[`address_${currentLang}`] || shop['address_zh-TW'] || '';
            const desc = shop[`description_${currentLang}`] || shop['description_zh-TW'] || '';
            const query = currentSearchQuery.toLowerCase();
            
            const matchesSearch = !query ||
                name.toLowerCase().includes(query) ||
                address.toLowerCase().includes(query) ||
                desc.toLowerCase().includes(query);

            return matchesCategory && matchesSearch;
        });
    }

    function renderShopCards(filteredShops) {
        if (currentLoadedShops === 0) {
            ui.shopCardsContainer.innerHTML = '';
        }

        const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
        
        shopsToDisplay.forEach(shop => {
            const isFavorited = favoriteShops.includes(shop.id);
            const card = document.createElement('div');
            card.className = 'shop-card bg-white rounded-xl overflow-hidden shadow-md relative';
            card.innerHTML = `
                <div class="h-48 bg-green-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                </div>
                <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-shop-id="${shop.id}">
                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <div class="p-6">
                    <div>
                        <h3 class="text-xl font-bold">${shop[`name_${currentLang}`] || shop['name_zh-TW']}</h3>
                        <span class="tag px-2 py-1 rounded-full text-xs">${shop[`type_${currentLang}`] || shop['type_zh-TW']}</span>
                        <p class="text-gray-600 my-4 h-20 overflow-hidden">${shop[`description_${currentLang}`] || shop['description_zh-TW']}</p>
                    </div>
                    <button class="block w-full text-center py-2 btn-primary rounded-lg font-medium view-details-btn" data-shop-id="${shop.id}">${translations[currentLang].viewDetailsBtn}</button>
                </div>
            `;
            ui.shopCardsContainer.appendChild(card);
        });

        currentLoadedShops += shopsToDisplay.length;
        ui.loadMoreButton.classList.toggle('hidden', currentLoadedShops >= filteredShops.length);
    }
    
    function updateMapMarkers(filteredShops) {
        if (!mapInstance) return;
        markersGroup.clearLayers();
        filteredShops.forEach(shop => {
            if(shop.lat && shop.lng) {
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`
                    <div class="p-1">
                        <h3 class="font-bold text-base">${shop[`name_${currentLang}`] || shop['name_zh-TW']}</h3>
                        <button onclick="window.showShopDetail('${shop.id}')" class="text-green-600 text-sm hover:underline">${translations[currentLang].viewDetailsBtn}</button>
                    </div>
                `);
                markersGroup.addLayer(marker);
            }
        });
        if (filteredShops.length > 0 && markersGroup.getLayers().length > 0) {
           mapInstance.fitBounds(markersGroup.getBounds(), { padding: [50, 50] });
        }
    }

    function filterAndDisplayShops() {
        const filteredShops = getFilteredShops();
        renderShopCards(filteredShops);
        updateMapMarkers(filteredShops);
    }
    
    window.showShopDetail = (shopId) => {
        const shop = allShops.find(s => s.id === shopId);
        if (!shop) return;
        
        ui.shopDetailModal.dataset.shopId = shopId;
        const T = (key) => translations[currentLang][key] || translations['zh-TW'][key];

        ui.shopDetailContainer.innerHTML = `
            <div class="shop-detail-header py-12 text-white rounded-t-xl text-center relative">
                <h1 class="text-3xl font-bold">${shop[`name_${currentLang}`] || shop['name_zh-TW']}</h1>
                <p class="text-lg">${shop[`type_${currentLang}`] || shop['type_zh-TW']}</p>
                <button id="close-modal" class="absolute top-4 right-4 bg-white/80 rounded-full p-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6">
                 <p class="text-gray-700 mb-4">${shop[`longDescription_${currentLang}`] || shop[`longDescription_zh-TW`] || shop[`description_${currentLang}`] || shop['description_zh-TW'] || T('notProvided')}</p>
                 <div class="bg-green-50 p-4 rounded-xl space-y-2">
                    <p><strong>${T('modalAddress')}:</strong> ${shop[`address_${currentLang}`] || shop['address_zh-TW'] || T('notProvided')}</p>
                    <p><strong>${T('modalPhone')}:</strong> ${shop.phone || T('notProvided')}</p>
                    <p><strong>${T('modalWebsite')}:</strong> ${shop.website ? `<a href="//${shop.website.replace(/^https?:\/\//,'')}" target="_blank" class="text-green-600 hover:underline">${shop.website}</a>` : T('notProvided')}</p>
                 </div>
                 ${localStorage.getItem('authToken') ? `<button id="recommend-btn" data-shop-id="${shopId}" class="mt-4 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">${T('adminRecommendBtn')}</button>` : ''}
            </div>
        `;
        
        ui.shopDetailModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        document.getElementById('close-modal').addEventListener('click', closeModal);
        const recommendBtn = document.getElementById('recommend-btn');
        if(recommendBtn) recommendBtn.addEventListener('click', handleRecommend);
    }
    
    function closeModal() {
        ui.shopDetailModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function showMessage(message) {
        ui.messageModalText.textContent = message;
        ui.messageModal.classList.remove('hidden');
    }

    // ===== EVENT HANDLERS =====
    function handleSearch() {
        currentSearchQuery = document.getElementById('search-input').value.trim();
        currentLoadedShops = 0;
        filterAndDisplayShops();
    }

    function handleFilter(e) {
        const btn = e.target.closest('.tag');
        if (!btn) return;
        document.querySelectorAll('#filter-buttons-container .tag').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilterCategory = btn.dataset.category;
        currentLoadedShops = 0;
        filterAndDisplayShops();
    }
    
    function toggleFavorite(shopId) {
        const index = favoriteShops.indexOf(shopId);
        if (index > -1) {
            favoriteShops.splice(index, 1);
        } else {
            favoriteShops.push(shopId);
        }
        localStorage.setItem('favoriteShops', JSON.stringify(favoriteShops));
        
        const btn = document.querySelector(`.favorite-btn[data-shop-id="${shopId}"]`);
        if(btn) btn.classList.toggle('favorited', index === -1);

        if (currentFilterCategory === 'favorites') {
            currentLoadedShops = 0;
            filterAndDisplayShops();
        }
    }

    async function handleNewsletter(e) {
        e.preventDefault();
        const email = document.getElementById('newsletter-email').value.trim();
        if (!email) return;
        const result = await apiFetch('subscribe', { email });
        if (result) {
            showMessage(translations[currentLang].newsletterSuccess);
            e.target.reset();
        }
    }
    
    async function handleRecommend(e) {
        const shopId = e.target.dataset.shopId;
        if(!shopId) return;
        
        showMessage(translations[currentLang].recommendationSending);
        
        const result = await apiFetch('sendRecommendation', { shopId }, true);
        if (result) {
            showMessage(result.message || translations[currentLang].recommendationSuccess);
        }
    }

    function promptAdminLogin() {
        const password = prompt(translations[currentLang].adminLoginPrompt);
        if (!password) return;
        apiFetch('login', { payload: { password } }).then(data => {
            if (data && data.token) {
                localStorage.setItem('authToken', data.token);
                ui.adminIndicator.classList.remove('hidden');
                showMessage(translations[currentLang].adminLoginSuccess);
            }
        });
    }

    // ===== INITIALIZATION =====
    async function initialize() {
        const data = await apiFetch('getPublicData');
        if (data && data.shops) {
            allShops = data.shops;
            
            const shopTypes = [...new Set(allShops.map(s => s['type_zh-TW']))];
            const filterContainer = document.getElementById('filter-buttons-container');
            shopTypes.forEach(type => {
                if(!type) return;
                const btn = document.createElement('button');
                btn.className = 'tag px-3 py-1 rounded-full text-sm';
                btn.dataset.category = type; 
                btn.textContent = type;
                filterContainer.appendChild(btn);
            });
            
            filterAndDisplayShops();
        }
        if (data && data.announcements && String(data.announcements).trim()) {
            ui.announcementText.textContent = data.announcements;
            ui.announcementBar.classList.remove('hidden');
        }

        initializeMap();
        setLanguage(currentLang);
        setupEventListeners();

        if (localStorage.getItem('authToken')) {
            ui.adminIndicator.classList.remove('hidden');
        }
    }

    function initializeMap() {
        if (document.getElementById('sustainability-map')._leaflet_id) return;
        mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);
        markersGroup.addTo(mapInstance);
    }
    
    function setupEventListeners() {
        document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));
        document.getElementById('language-select-mobile').addEventListener('change', (e) => setLanguage(e.target.value));
        document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
        document.getElementById('search-button').addEventListener('click', handleSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && handleSearch());
        document.getElementById('filter-buttons-container').addEventListener('click', handleFilter);
        ui.loadMoreButton.addEventListener('click', () => renderShopCards(getFilteredShops()));
        ui.shopCardsContainer.addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-details-btn');
            const favBtn = e.target.closest('.favorite-btn');
            if (viewBtn) showShopDetail(viewBtn.dataset.shopId);
            if (favBtn) toggleFavorite(favBtn.dataset.shopId);
        });
        document.getElementById('newsletter-form').addEventListener('submit', handleNewsletter);
        
        document.getElementById('issue-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const issueText = document.getElementById('issue').value.trim();
            const submitButton = this.querySelector('button[type="submit"]');
            if (!issueText) return;

            submitButton.disabled = true;
            submitButton.textContent = '...';

            try {
                const response = await fetch('https://formsubmit.co/ajax/artistworld0815@gmail.com', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ _subject: "永續商店地圖 - 問題回報", message: issueText })
                });
                const result = await response.json();
                if (result.success === "true" || response.ok) {
                    document.getElementById('issue-message').classList.remove('hidden');
                    this.reset();
                    setTimeout(() => { document.getElementById('issue-message').classList.add('hidden'); }, 5000);
                } else { throw new Error('Formsubmit.co returned an error.'); }
            } catch (error) {
                console.error("Issue report error:", error);
                showMessage(translations[currentLang].reportIssueErrorMsg);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = translations[currentLang].reportIssueSubmitBtn;
            }
        });
        
        document.getElementById('close-message-modal').addEventListener('click', () => ui.messageModal.classList.add('hidden'));
        document.getElementById('close-error-modal').addEventListener('click', () => ui.errorModal.classList.add('hidden'));
        ui.shopDetailModal.addEventListener('click', (e) => e.target === ui.shopDetailModal && closeModal());
        document.addEventListener('keydown', e => (e.ctrlKey && e.shiftKey && e.key === 'A') && promptAdminLogin());
    }

    initialize();
});
</script>

</body>
</html>
